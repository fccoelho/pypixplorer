import xmlrpc.client as xmlrpcclient
import requests
from tinydb import TinyDB, Query

class Index:
    """
    Connects with remote server. PyPI by default.
    """

    def __init__(self, server='https://pypi.python.org/pypi', cache_path='pypiexplorer_cache.json'):
        self.client = xmlrpcclient.ServerProxy(server)
        self.cache = TinyDB(cache_path)

    def _get_JSON(self, package_name):
        """
        Gets JSON record for a given package
        :param package_name: name of the package
        :return: dictionary
        """
        Package = Query()
        results = self.cache.search(Package.info.name == package_name)
        # TODO: check if the package data has been updated since last time.
        if results != []:
            data = results[0]
            # print("fetched from cache")
        else:
            url = 'http://pypi.python.org/pypi/{}/json'.format(package_name)
            ans = requests.get(url)
            data = ans.json()
            self._update_cache(data)
        return data

    def _update_cache(self, data):
        self.cache.insert(data)

    def get_releases(self, package_name):
        return self.client.package_releases(package_name)

    def get_dependencies(self, package_name):
        raise NotImplementedError

    def dependency_graph(self, package_name):
        raise NotImplementedError

    def get_popularity(self, package_name):
        """
        :param package_name: name of the package
        :return: dictionary of number of downloads. keys are 'last_month', 'last_week' and 'last_day'
        """

        return self._get_JSON("numpy")["info"]["downloads"]

    def release_series(self, package_name):
        raise NotImplementedError

    def get_by_TROVE_classifier(self, trove):
        raise NotImplementedError

    def get_well_maintained(self):
        """
        Get packages which have had at least one release in the last six months, sorted by most recently updated
        """
        raise NotImplementedError
